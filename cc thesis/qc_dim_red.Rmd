---
title: "AML4 - QC, normalization and scaling, dimensional reduction"
author: "Chiara_Caprioli"
date: "26/02/2022"
output:
  html_document:
    code_folding: hide
---

## Set up
```{r, warning=FALSE, message=FALSE}
#load packages
library(tidyverse)
library(Seurat)
library(scran)
library(scater)
library(patchwork)
library(viridis)
library(ggforce)
library(gghalves)
library(ggridges)
library(scDblFinder)
library(SeuratDisk)
library(SeuratObject)
```

```{r, setup, include=FALSE}
# set working directory
knitr::opts_knit$set(root.dir = '/hpcnfs/scratch/PGP/ccaprioli/working/SRSF2_3_AMLs')

dir.create('./data/AML4')
dir.create('./plots/AML4')
dir.create('./qc/plots/AML4')
```

```{r, warning=FALSE, message=FALSE}
#set colors 
colors <- list()

colors$sample <- setNames(
  c("#227093", "#ffb142", "#485460"),
  c("AML4", "AML5", "sAML1")
)

colors$cell_cycle <- setNames(
  c("#45aaf2", "#f1c40f", "#e74c3c", "#7f8c8d"),
  c("G1", "S", "G2M", "-")
)

colors_dutch <- c(
  "#F79F1F","#A3CB38","#1289A7","#D980FA","#B53471",
  "#EE5A24","#009432","#0652DD","#9980FA","#833471",
  "#EA2027","#006266","#1B1464","#5758BB","#6F1E51",
  "#FFC312","#C4E538","#12CBC4","#FDA7DF","#ED4C67"
)
colors_indian <- c(
  "#FEA47F","#25CCF7","#EAB543","#55E6C1","#CAD3C8",
  "#F97F51","#1B9CFC","#F8EFBA","#58B19F","#2C3A47",
  "#B33771","#3B3B98","#FD7272","#9AECDB","#D6A2E8",
  "#6D214F","#182C61","#FC427B","#BDC581","#82589F"
)
colors$discrete <- c(colors_dutch, colors_indian)
```

## Helper functions
```{r, warning=FALSE, message=FALSE}
niceFormat <- function(number) {
  formatC(number, format = "f", big.mark = ",", digits = 0)
}

load10xData <- function(
  sample_name,
  path,
  max_number_of_cells = NULL
) {

  ## read transcript count matrix
  transcript_counts <- list.files(
      path,
      recursive = TRUE,
      full.names = TRUE
    ) %>%
    .[grep(., pattern = 'mtx')] %>%
    Matrix::readMM()

  ## read cell barcodes and assign as column names of transcript count matrix
  colnames(transcript_counts) <- list.files(
      path,
      recursive = TRUE,
      full.names = TRUE
    ) %>%
    .[grep(., pattern = 'barcodes')] %>%
    .[grep(., pattern = 'tsv')] %>%
    read_tsv(col_names = FALSE, col_types = cols()) %>%
    pull(1) %>%
    gsub(., pattern = '-[0-9]{1,2}', replacement = '') %>%
    paste0(., '-', sample_name)

  ## read gene names
  gene_names <- list.files(
      path,
      recursive = TRUE,
      full.names = TRUE
    ) %>%
    .[grep(., pattern = 'genes|features')] %>%
    read_tsv(col_names = FALSE, col_types = cols()) %>%
    pull(ifelse(ncol(.) > 1, 2, 1))

  ## if necessary, merge counts from different transcripts of the same gene
  if ( any(duplicated(gene_names)) == TRUE ) {

    ## get names of genes with multiple entries
    duplicated_gene_names <- unique(gene_names[which(duplicated(gene_names))])

    ## log message
    message(
      glue::glue(
        "{format(Sys.time(), '[%Y-%m-%d %H:%M:%S]')} Summing up counts for ",
        "{length(duplicated_gene_names)} genes with multiple entries."
      )
    )

    ## go through genes with multiple entries
    for ( i in duplicated_gene_names ) {

      ## extract transcripts counts for current gene
      tmp_counts <- transcript_counts[which(gene_names == i),]

      ## make sure at least 2 rows are present
      if ( nrow(tmp_counts) >= 2 ) {

        ## sum up counts in each cell
        tmp_counts_sum <- Matrix::colSums(tmp_counts)

        ## remove original counts from transcript matrix and the gene name from
        ## the list of gene names
        transcript_counts <- transcript_counts[-c(which(gene_names == i)),]
        gene_names <- gene_names[-c(which(gene_names == i))]

        ## add summed counts to end of transcript count matrix and current gene
        ## name to end of gene names
        transcript_counts <- rbind(transcript_counts, tmp_counts_sum)
        gene_names <- c(gene_names, i)
      }
    }
  }

  ## assign gene names as row names
  rownames(transcript_counts) <- gene_names

  ## down-sample cells if more cells than `max_number_of_cells` are present in
  ## count matrix
  if (
    !is.null(max_number_of_cells) &&
    is.numeric(max_number_of_cells) &&
    max_number_of_cells < ncol(transcript_counts)
  ) {
    temp_cells_to_keep <- base::sample(1:ncol(transcript_counts), max_number_of_cells)
    transcript_counts <- transcript_counts[,temp_cells_to_keep]
  }

  ##
  message(
    glue::glue(
      "{format(Sys.time(), '[%Y-%m-%d %H:%M:%S]')} Loaded counts for sample ",
      "{sample_name} with {niceFormat(ncol(transcript_counts))} cells and ",
      "{niceFormat(nrow(transcript_counts))} genes."
    )
  )

  ##
  return(transcript_counts)
}

sameGeneNames <- function(counts) {

  ## create place holder for gene names from each count matrix
  gene_names <- list()

  ## go through count matrices
  for ( i in names(counts) ) {

    ## extract gene names
    gene_names[[i]] <- rownames(counts[[i]])
  }

  ## check if all gene names are the same (using the first matrix as a reference
  ## for the others)
  return(all(sapply(gene_names, FUN = identical, gene_names[[1]])))
}

averagenCountnFeature <- function(cells) {
  output <- tibble(
    'sample' = character(),
    'mean(nCount)' = numeric(),
    'median(nCount)' = numeric(),
    'mean(nFeature)' = numeric(),
    'median(nFeature)' = numeric()
  )
  for ( i in levels(cells$sample) ) {
    tmp <- tibble(
      'sample' = i,
      'mean(nCount)' = cells %>% filter(sample == i) %>% pull(nCount) %>% mean(),
      'median(nCount)' = cells %>% filter(sample == i) %>% pull(nCount) %>% median(),
      'mean(nFeature)' = cells %>% filter(sample == i) %>% pull(nFeature) %>% mean(),
      'median(nFeature)' = cells %>% filter(sample == i) %>% pull(nFeature) %>% median()
    )
    output <- bind_rows(output, tmp)
  }
  return(output)
}
```

## Load sample
```{r}
sample_names <- "AML4"

transcripts <- list(
  raw = list()
)

transcripts$raw$AML4 <- load10xData("AML4", '/hpcnfs/data/PGP/ccaprioli/cellranger6/AML4/outs/filtered_feature_bc_matrix', max_number_of_cells = NULL)
```

## Quality control
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
cells <- tibble(
  cell = colnames(transcripts$raw$AML4),
  sample = colnames(transcripts$raw$AML4) %>%
    strsplit("-") %>%
    vapply(FUN.VALUE = character(1), `[`, 2) %>%
    factor(levels = sample_names),
  nCount = colSums(transcripts$raw$AML4),
  nFeature = colSums(transcripts$raw$AML4 != 0)
)

DataFrame(cells)
```

### add column with mitochondrial genes (HUMAN)
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
mitochondrial_genes_here <- read_tsv("/hpcnfs/scratch/PGP/ccaprioli/resources/mt_gencode/genes_mt_hg_name.tsv.gz",
  col_names = FALSE
) %>%
  filter(X1 %in% rownames(transcripts$raw$AML4)) %>%
  pull(X1)

cells$percent_MT <-
  Matrix::colSums(transcripts$raw$AML4[mitochondrial_genes_here,]) /
  Matrix::colSums(transcripts$raw$AML4)

DataFrame(cells)

#saveRDS(cells, './data/AML4_cells_before_qc.rds')
```

### find and remove doublets
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}

sce <- SingleCellExperiment(assays = list(counts = transcripts$raw$AML4))
sce <- scDblFinder(sce)

cells$multiplet_class <- colData(sce)$scDblFinder.class

cells %>%
  filter(multiplet_class != 'singlet') %>%
  group_by(sample) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = sample, y = count, fill = sample)) +
  geom_col(color = 'black') +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_continuous(name = 'Number of doublets', labels = scales::comma) +
  theme(
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = 'none'
  ) +
  coord_flip()

ggsave(
  './qc/plots/AML4/qc_number_of_doublets_by_sample.png', height = 3, width = 6
)
```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
p1 <- ggplot(cells, aes(x = multiplet_class, y = nCount, fill = multiplet_class)) +
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = 'Number of transcripts', subtitle = 'linear scale') +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = 'none'
  ) +
  coord_flip()
p2 <- ggplot(cells, aes(x = multiplet_class, y = nCount, fill = multiplet_class)) +
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = 'Number of transcripts', subtitle = 'log-scale') +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = 'none'
  ) +
  coord_flip()
p3 <- ggplot(cells, aes(x = multiplet_class, y = nFeature, fill = multiplet_class)) +
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = 'Number of expressed genes', subtitle = 'linear scale') +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = 'none'
  ) +
  coord_flip()
p4 <- ggplot(cells, aes(x = multiplet_class, y = nFeature, fill = multiplet_class)) +
  geom_violin(draw_quantiles = c(0.5), scale = 'area', trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$multiplet_class))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = 'Number of expressed genes', subtitle = 'log-scale') +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = 'none'
  ) +
  coord_flip()

ggsave(
  "./qc/plots/AML4/qc_nCount_nFeature_by_multiplet_class.png",
  p1 + p3 + p2 + p4 + plot_layout(ncol = 2),
  height = 7, width = 10
)
```

```{r}
cells <- filter(cells, multiplet_class == "singlet")
```

### Find and remove low quality cells

#### check before filtering
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}

p1 <- ggplot(cells, aes(x = sample, y = nCount, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of transcripts", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p2 <- ggplot(cells, aes(x = sample, y = nCount, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = "Number of transcripts", subtitle = "log-scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p3 <- ggplot(cells, aes(x = sample, y = nFeature, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of expressed genes", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p4 <- ggplot(cells, aes(x = sample, y = nFeature, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = "Number of expressed genes", subtitle = "log-scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p5 <- ggplot(cells, aes(x = sample, y = percent_MT, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$discrete) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Percent MT transcripts", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()

ggsave(
  "./qc/plots/AML4/qc_histogram_nCount_nFeature_percentMT_before_filtering_1.png",
  p1 + p3 + p5 +
    p2 + p4 + plot_layout(ncol = 3),
  height = 7, width = 10)

```

##### Plot nFeature/nCount
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}

cells %>% filter(sample == 'AML4') %>%
  ggplot(aes(nCount, nFeature, color = percent_MT)) +
  geom_point(size = 0.5) +
  scale_x_continuous(name = "Number of transcripts", labels = scales::comma) +
  scale_y_continuous(name = "Number of expressed genes", labels = scales::comma) +
  theme_bw() +
  ggtitle('AML4') +
  scale_color_viridis(
    name = "Percent MT\ntranscripts",
    limits = c(0,1),
    labels = scales::percent,
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  )

ggsave("./qc/plots/AML4/qc_nFeature_over_nCount_before_filtering.png", height = 4, width = 6)
```

##### Define adaptive thresholds for filtering
```{r, include=TRUE, warning=FALSE, message=FALSE}
cells <- cells 

median_nCount <- median(cells$nCount) 

mad_nCount <- mad(cells$nCount) 

median_nFeature <- median(cells$nFeature) 

mad_nFeature <- mad(cells$nFeature) 

median_percent_MT <- median(cells$percent_MT) 

mad_percent_MT <- mad(cells$percent_MT)
```

```{r, include=TRUE, warning=FALSE, message=FALSE}
as.data.frame(list(
  median_nCount = median_nCount,
  mad_nCount = mad_nCount,
  median_nFeature = median_nFeature,
  mad_nFeature = mad_nFeature,
  median_percent_MT = median_percent_MT,
  mad_percent_MT = mad_percent_MT
)) 
```

##### Set thresholds 
It is generally advised to stay within 3-5 MADs around the median.
```{r, warning=FALSE, message=FALSE}

thresholds_nCount <- c(0, median_nCount + 5*mad_nCount)

thresholds_nFeature <- c(0, median_nFeature + 4*mad_nFeature)

thresholds_percent_MT <- c(0, median_percent_MT + 0.5*mad_percent_MT)
```

##### Plot thresholds 
```{r}
p1 <- ggplot(cells, aes(nCount)) +
  geom_histogram(binwidth = 20) +
  geom_vline(xintercept = median_nCount, color = "cyan") +
  geom_vline(xintercept = thresholds_nCount, color = "red") +
  theme_bw() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of transcripts")

p2 <- ggplot(cells, aes(nFeature)) +
  geom_histogram(binwidth = 20) +
  geom_vline(xintercept = median_nFeature, color = "cyan") +
  geom_vline(xintercept = thresholds_nFeature, color = "red") +
  theme_bw() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of expressed genes")

p3 <- ggplot(cells, aes(percent_MT)) +
  geom_histogram(binwidth = 0.005) +
  geom_vline(xintercept = median_percent_MT, color = "cyan") +
  geom_vline(xintercept = thresholds_percent_MT, color = "red") +
  theme_bw() +
  labs(title = "Percent MT transcripts")

ggsave(
  "./qc/plots/AML4/qc_histogram_nCount_nFeature_percentMT_thresholds.png",
  p1 + p2 + p3 + plot_layout(ncol = 3), height = 4, width = 14
)
```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
p1 <- ggplot(cells, aes(x = sample, y = nCount, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  geom_hline(yintercept = median_nCount, color = "black") +
  geom_hline(yintercept = thresholds_nCount, color = "red") +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of transcripts", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p2 <- ggplot(cells, aes(x = sample, y = nCount, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  geom_hline(yintercept = median_nCount, color = "black") +
  geom_hline(yintercept = thresholds_nCount, color = "red") +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = "Number of transcripts", subtitle = "log-scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p3 <- ggplot(cells, aes(x = sample, y = nFeature, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  geom_hline(yintercept = median_nFeature, color = "black") +
  geom_hline(yintercept = thresholds_nFeature, color = "red") +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of expressed genes", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p4 <- ggplot(cells, aes(x = sample, y = nFeature, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  geom_hline(yintercept = median_nFeature, color = "black") +
  geom_hline(yintercept = thresholds_nFeature, color = "red") +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = "Number of expressed genes", subtitle = "log-scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p5 <- ggplot(cells, aes(x = sample, y = percent_MT, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  geom_hline(yintercept = median_percent_MT, color = "black") +
  geom_hline(yintercept = thresholds_percent_MT, color = "red") +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells$sample))) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Percent MT transcripts", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
ggsave(
  "./qc/plots/AML4/qc_vln_nCount_nFeature_percentMT_thresholds.png",
  p1 + p3 + p5 +
    p2 + p4 + plot_layout(ncol = 3),
  height = 7, width = 10
)
```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
ggplot(cells, aes(nCount, nFeature, color = percent_MT)) +
  geom_point(size = 0.5) +
  geom_hline(yintercept = thresholds_nFeature, color = "red") +
  geom_vline(xintercept = thresholds_nCount, color = "red") +
  scale_x_continuous(name = "Number of transcripts", labels = scales::comma) +
  scale_y_continuous(name = "Number of expressed genes", labels = scales::comma) +
  theme_bw() +
  ggtitle('AML4') +
  scale_color_viridis(
    name = "Percent MT\ntranscripts",
    limits = c(0,1),
    labels = scales::percent,
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  )

ggsave("./qc/plots/AML4/qc_nFeature_over_nCount_thresholds.png", height = 4, width = 6)
```

##### Filter cells 
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
cells_filtered <- cells %>%
  dplyr::filter(
    nCount >= thresholds_nCount[1],
    nCount <= thresholds_nCount[2],
    nFeature >= thresholds_nFeature[1],
    nFeature <= thresholds_nFeature[2],
    percent_MT >= thresholds_percent_MT[1],
    percent_MT <= thresholds_percent_MT[2]
  )

DataFrame(cells_filtered)
```

#### Check after filtering out low-quality cells
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
p1 <- ggplot(cells_filtered, aes(x = sample, y = nCount, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells_filtered$sample))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of transcripts", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p2 <- ggplot(cells_filtered, aes(x = sample, y = nCount, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells_filtered$sample))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = "Number of transcripts", subtitle = "log-scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p3 <- ggplot(cells_filtered, aes(x = sample, y = nFeature, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells_filtered$sample))) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of expressed genes", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p4 <- ggplot(cells_filtered, aes(x = sample, y = nFeature, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells_filtered$sample))) +
  scale_y_log10(labels = scales::comma) +
  labs(title = "Number of expressed genes", subtitle = "log-scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
p5 <- ggplot(cells_filtered, aes(x = sample, y = percent_MT, fill = sample)) +
  geom_violin(draw_quantiles = c(0.5), scale = "area", trim = FALSE) +
  theme_bw() +
  scale_fill_manual(values = colors$sample) +
  scale_x_discrete(limits = rev(levels(cells_filtered$sample))) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Percent MT transcripts", subtitle = "linear scale") +
  theme(
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
ggsave(
  "./qc/plots/AML4/qc_histogram_nCount_nFeature_percentMT_filtered.png",
  p1 + p3 + p5 +
    p2 + p4 + plot_layout(ncol = 3),
  height = 7, width = 10
)

p <- ggplot(cells_filtered, aes(nCount, nFeature, color = percent_MT)) +
  geom_point(size = 0.5) +
  scale_x_continuous(name = "Number of transcripts", labels = scales::comma) +
  scale_y_continuous(name = "Number of expressed genes", labels = scales::comma) +
  theme_bw() +
  scale_color_viridis(
    name = "Percent MT\ntranscripts",
    limits = c(0,1),
    labels = scales::percent,
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  )
ggsave("./qc/plots/AML4/qc_nFeature_over_nCount_filtered.png", p, height = 4, width = 6)

```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
cells_to_keep <- cells_filtered$cell

length(cells_to_keep) # 1940
```

### remove genes which are expressed in fewer than 3 cells
```{r, warning=FALSE, message=FALSE}
genes <- tibble(
  gene = rownames(transcripts$raw$AML4),
  count = Matrix::rowSums(transcripts$raw$AML4),
  cells = Matrix::rowSums(transcripts$raw$AML4 != 0)
)
genes_to_keep <- genes %>% dplyr::filter(cells >= 3) %>% pull(gene)
length(genes_to_keep) # 18759
```

## Generate filtered high-quality matrix
```{r, warning=FALSE, message=FALSE}
transcripts$raw$filtered <- transcripts$raw$AML4[genes_to_keep,cells_to_keep]
cells_per_sample_after_filtering <- tibble(
  sample = character(),
  before = numeric(),
  after = numeric()
)
for ( i in sample_names ) {
  tmp <- tibble(
    sample = i,
    before = grep(colnames(transcripts$raw$AML4), pattern = paste0("-", i, "$"))
    %>% length(),
    after = grep(colnames(transcripts$raw$filtered), pattern = paste0("-", i,
                                                                      "$")) %>% length()
  )
  cells_per_sample_after_filtering <- bind_rows(cells_per_sample_after_filtering, tmp)
}
knitr::kable(cells_per_sample_after_filtering)
```

```{r}
saveRDS(transcripts$raw$filtered, './data/AML4/AML4_raw_matrix_filtered.rds')
```

## Create Seurat object
```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
AML4 <- CreateSeuratObject(
  counts = transcripts$raw$filtered,
  min.cells = 0,
  min.features = 0
)

#store sample assignment for every cell in the meta data
AML4@meta.data$sample <- Cells(AML4) %>%
  strsplit("-") %>%
  vapply(FUN.VALUE = character(1), `[`, 2) %>%
  factor(levels = sample_names)

```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
#check again the distribution of number of transcripts and expressed genes per cell by sample 
temp_labels <- AML4@meta.data %>%
  group_by(sample) %>%
  tally()

p1 <- ggplot() +
  geom_half_violin(
    data = AML4@meta.data, aes(sample, nCount_RNA, fill = sample),
    side = "l", show.legend = FALSE, trim = FALSE
  ) +
  geom_half_boxplot(
    data = AML4@meta.data, aes(sample, nCount_RNA, fill = sample),
    side = "r", outlier.color = NA, width = 0.4, show.legend = FALSE
  ) +
  geom_text(
    data = temp_labels,
    aes(x = sample, y = -Inf, label = paste0("n = ", format(n, big.mark = ",",
                                                            trim = TRUE)), vjust = -1),
    color = "black", size = 2.8
  ) +
  scale_color_manual(values = colors$sample) +
  scale_fill_manual(values = colors$sample) +
  scale_y_continuous(labels = scales::comma, expand = c(0.08,0)) +
  theme_bw() +
  labs(x = "", y = "Number of transcripts") +
  theme(
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank()
  )

p2 <- ggplot() +
  geom_half_violin(
    data = AML4@meta.data, aes(sample, nFeature_RNA, fill = sample),
    side = "l", show.legend = FALSE, trim = FALSE
  ) +
  geom_half_boxplot(
    data = AML4@meta.data, aes(sample, nFeature_RNA, fill = sample),
    side = "r", outlier.color = NA, width = 0.4, show.legend = FALSE
  ) +
  geom_text(
    data = temp_labels,
    aes(x = sample, y = -Inf, label = paste0("n = ", format(n, big.mark = ",",
                                                            trim = TRUE)), vjust = -1),
    color = "black", size = 2.8
  ) +
  scale_color_manual(values = colors$sample) +
  scale_fill_manual(values = colors$sample) +
  scale_y_continuous(
    name = "Number of expressed genes",
    labels = scales::comma, expand = c(0.08,0)
  ) +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    axis.title.x = element_blank()
  )

ggsave(
  "./qc/plots/AML4/nCount_nFeature_by_sample.png",
  p1 + p2 + plot_layout(ncol = 2), height = 4, width = 10
)
```

### Add percentage of mitochondrial genes in metadata
```{r}
DefaultAssay(object = AML4) <- "RNA"
AML4[["percent_MT"]] <- PercentageFeatureSet(AML4, "MT-")
```

## Normalization

### Log normalization (for use during cell lineage imputation)
```{r}
# normalization
AML4_log <- NormalizeData(AML4, normalization.method = "LogNormalize", scale.factor = 10000)

# feature selection
AML4_log <- FindVariableFeatures(AML4_log, selection.method = "vst", nfeatures = 2000)

# scaling
all.genes <- rownames(AML4_log)
AML4_log <- ScaleData(AML4_log, features = all.genes)

# PCA
AML4_log <- RunPCA(AML4_log, features = VariableFeatures(object = AML4_log))
```

```{r}
DimPlot(AML4_log, reduction = 'pca') + NoLegend()
```

```{r}
DimHeatmap(AML4_log, reduction = "pca", dims = 1:15, nfeatures = 5, cells = 500, balanced = TRUE)
```


```{r}
#Determine the ‘dimensionality’ of the dataset

ElbowPlot(AML4_log)
```


```{r}
# UMAP
AML4_log <- RunUMAP(
  AML4_log,
  reduction.name = 'UMAP',
  reduction = 'pca',
  dims = 1:15,
  n.components = 2,
  seed.use = 100
)
```

```{r}
saveRDS(AML4_log, './data/AML4/AML4_log.rds')
```

### SCT normalization 
This single command replaces NormalizeData(), ScaleData(), and FindVariableFeatures().
Transformed data will be available in the SCT assay, which is set as the default after running sctransform:
*'counts' = corrected counts
*'data' = log1p(counts)
*'scale.data' = pearson residuals

With regression of possible confounding factors

```{r, warning=FALSE, message=FALSE}
AML4 <- SCTransform(AML4, 
                    assay = 'RNA',
                    new.assay.name = 'SCT',
                    variable.features.n = 3000,
                    vars.to.regress = "percent_MT", 
                    return.only.var.genes = FALSE,
                    do.correct.umi = TRUE,
                    verbose = T) 

AML4 <- CellCycleScoring(
  AML4,
  s.features = cc.genes$s.genes,
  g2m.features = cc.genes$g2m.genes,
  assay = 'SCT'
)
AML4@meta.data$cell_cycle_seurat <- AML4@meta.data$Phase
AML4@meta.data$Phase <- NULL
AML4@meta.data$cell_cycle_seurat <- factor(
  AML4@meta.data$cell_cycle_seurat, levels = c("G1", "S", "G2M")
)

#AML4 <- SCTransform(
#  AML4,
#  assay = 'RNA',
#  new.assay.name = 'SCT',
#  variable.features.n = 3000,
#  vars.to.regress = c('percent_MT', 'S.Score', 'G2M.Score')
#)
```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(AML4), 10)
top10
```

## Principal component analysis
```{r, warning=FALSE, message=FALSE}
# Perform linear dimensional reduction on 50 PCs (default)
AML4 <- RunPCA(AML4)
```

```{r}
DimPlot(AML4, reduction = 'pca', group.by = 'sample', cols = colors$sample, pt.size = 0.5) +
  theme_bw() +
  theme(panel.grid = element_blank(), plot.title = element_blank(), legend.position = 'none')

ggsave('./plots/AML4/pca_sample.png', height = 4, width = 4)
```

```{r, include=TRUE, warning=FALSE, message=FALSE, out.width="100%", fig.align="center"}
# inspect PCA
print(AML4[["pca"]], dims = 1:5, nfeatures = 5)

p1 <- VizDimLoadings(AML4, dims = 1:2, reduction = "pca")
ggsave("./plots/AML4/pc1_2.png", p1, width=12, height=7)

png("./plots/AML4/pcaHeatmap.png")
DimHeatmap(AML4, dims = 1:20, cells = 500, balanced = TRUE)
dev.off()
```

```{r, include=TRUE, warning=FALSE, message=FALSE, out.width="50%"}
# determine the ‘dimensionality’ of the dataset and choose PCs to include

ElbowPlot(AML4, ndims = 50, reduction = 'pca') +
  geom_vline(xintercept = 30, color = "red") +
  theme_bw() +
  theme(panel.grid = element_blank())


ggsave("./plots/AML4/elbow_plot.png", width=6, height=6)
```

## UMAP
```{r, include=TRUE, warning=TRUE, message=TRUE}
# Non-linear dimensional reduction using the same PCs as input to the clustering analysis

AML4 <- RunUMAP(
  AML4,
  reduction.name = "UMAP",
  reduction = "pca",
  dims = 1:50,
  n.components = 2,
  seed.use = 100
)
```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
#UMAP_samples
bind_cols(AML4@meta.data, as.data.frame(AML4@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = sample)) +
  geom_point(size = 0.2, alpha = 0.8) +
  theme_bw() +
  scale_color_manual(values = colors$sample) +
  labs(color = "Sample") +
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  theme(legend.position = "nonw", panel.grid = element_blank()) +
  coord_fixed() +
  annotate(
    geom = "text", x = Inf, y = -Inf,
    label = paste0("n = ", format(nrow(AML4@meta.data), big.mark = ",", trim =
                                    TRUE)),
    vjust = -1.5, hjust = 1.25, color = "black", size = 3.2
  )

ggsave(
  "./plots/AML4/umap_by_sample.png",
  height = 6, width = 8
)
```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
#UMAP_nCount
bind_cols(AML4@meta.data, as.data.frame(AML4@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = nCount_RNA)) +
  geom_point(size = 0.2, alpha = 0.8) +
  theme_bw() +
  scale_color_viridis(
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black"),
    labels = scales::comma,
  ) +
  labs(color = "Number of\ntranscripts") +
  theme(legend.position = "right", panel.grid = element_blank()) +
  coord_fixed() +
  annotate(
    geom = "text", x = Inf, y = -Inf,
    label = paste0("n = ", format(nrow(AML4@meta.data), big.mark = ",", trim =
                                    TRUE)),
      vjust = -1.5, hjust = 1.25, color = "black", size = 2.5
  )

ggsave(
  "./plots/AML4/umap_by_nCount_RNA.png",
  height = 6, width = 8
)
```

```{r}
bind_cols(AML4@meta.data, as.data.frame(AML4@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = nCount_SCT)) +
  geom_point(size = 0.2, alpha = 0.8) +
  theme_bw() +
  scale_color_viridis(
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black"),
    labels = scales::comma,
  ) +
  labs(color = "Number of\ntranscripts") +
  theme(legend.position = "right", panel.grid = element_blank()) +
  coord_fixed() +
  annotate(
    geom = "text", x = Inf, y = -Inf,
    label = paste0("n = ", format(nrow(AML4@meta.data), big.mark = ",", trim =
                                    TRUE)),
      vjust = -1.5, hjust = 1.25, color = "black", size = 2.5
  )

ggsave(
  "./plots/AML4/umap_by_nCount_SCT.png",
  height = 6, width = 8
)
```

```{r, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
#UMAP by mitochondrial genes
bind_cols(AML4@meta.data, as.data.frame(AML4@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = percent_MT)) +
  geom_point(size = 0.2) +
  theme_classic() +
  scale_color_viridis(
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black"),
    labels = scales::comma,
  )

ggsave(
  "./plots/AML4/umap_by_mit_genes.png",
  height = 6, width = 8
)
```

## Cell cycle analysis
```{r, include=TRUE, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
# percentage

table_samples_by_cell_cycle <- AML4@meta.data %>%
  group_by(sample, cell_cycle_seurat) %>%
  summarize(count = n()) %>%
  spread(cell_cycle_seurat, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('sample', 'total_cell_count', everything())) %>%
  arrange(factor(sample, levels = levels(AML4@meta.data$cell_cycle_seurat)))

temp_labels <- AML4@meta.data %>%
  group_by(sample) %>%
  tally()

table_samples_by_cell_cycle %>%
  select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'sample') %>%
  mutate(sample = factor(sample, levels = levels(AML4@meta.data$sample))) %>%
  ggplot(aes(sample, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity') +
  geom_text(
    data = temp_labels,
    aes(x = sample, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 2.8
  ) +
  scale_fill_manual(name = 'Cell cycle', values = colors$cell_cycle) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'none',
    plot.title = element_text(hjust = 0.5),
    text = element_text(size = 16),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

ggsave("./plots/AML4/barplot_perc_cell_cycle.png", width = 2.5, height = 5)
```

```{r, include=TRUE, warning=FALSE, message=FALSE, out.width="75%", fig.align="center"}
#UMAP_cell_cycle
bind_cols(AML4@meta.data, as.data.frame(AML4@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = cell_cycle_seurat)) +
  geom_point(size = 0.2) +
  theme_classic() +
  scale_color_manual(values = colors$cell_cycle) +
  labs(color = "Cell cycle") +
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  theme(legend.position = "right") +
  coord_fixed() +
  annotate(
    geom = "text", x = Inf, y = -Inf,
    label = paste0("n = ", format(nrow(AML4@meta.data), big.mark = ",", trim = TRUE)),
    vjust = -1.5, hjust = 1.25, color = "black", size = 2.5
  )

ggsave(
  "./plots/AML4/umap_by_cell_cycle.png",
  height = 6, width = 8
)

```

```{r}
saveRDS(AML4, './data/AML4/AML4.rds')
```

```{r}
sessionInfo()
```