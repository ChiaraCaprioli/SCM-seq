---
title: "Finding best Louvain cluster resolution on integrated dataset"
author: "chiara caprioli"
date: "13/05/2022"
output: html_document
---
```{r}
library(tidyverse)
library(Seurat)
library(scran)
library(patchwork)
library(viridis)
library(ggforce)
library(gghalves)
library(ggridges)
library(clustree)
library(cluster)
library(igraph)
library(bluster)
library(pheatmap)
library(intrinsicDimension)
library(celldex)
library(SeuratDisk)
library(SeuratObject)
```

```{r}
colors <- list()

colors$sample <- setNames(
  c("#227093", "#ffb142", "#485460"),
  c("AML4", "AML5", "sAML1")
)

colors$cell_cycle <- setNames(
  c("#45aaf2", "#f1c40f", "#e74c3c", "#7f8c8d"),
  c("G1", "S", "G2M", "-")
)

colors$cell_type <- setNames(
  colors$cell_type <- c(
  "#FEA47F","#25CCF7","#EAB543","#55E6C1","#CAD3C8",
  "#F97F51","#1B9CFC","#F8EFBA","#58B19F","#2C3A47",
  "#B33771","#3B3B98","#FD7272","#9AECDB","#D6A2E8",
  "#6D214F","#182C61","#FC427B","#BDC581","#82589F",
  "#EE5A24","#009432", "#F79F1F", "#A3CB38", "#1289A7",
  "#D980FA", "#B53471"), 
c("HSC", "LMPP", "GMP", "Prog_RBC", "Prog_Mk", "Prog_DC", "pDC", "cDC2", "CD14 Mono", "CD16 Mono", "CD4 Naive", "CD4 Memory" , "CD8 Naive",  "CD8 Effector_1", "CD8 Effector_2", "CD8 Memory_1", "Treg", "MAIT", "gdT",  "NK", "CD56 bright NK", "CD8 Memory_2", "Prog_B 1", "Prog_B 2", "Naive B", "Memory B", "Plasmablast"))

colors$discrete <- c('#046C9AFF', '#D69C4EFF', '#899DA4FF', '#C93312FF', '#D8B70AFF',
  '#02401BFF', '#A2A475FF', '#81A88DFF', '#972D15FF', '#CADDE1FF',
  '#7B906FFF', '#174D79FF',  '#898989FF', '#D4CDB1FF', '#708090FF',
  '#6CA9C3FF', '#3A3533FF', '#000E33FF', '#800000FF',  '#175E78FF',
  '#DAA520FF', '#798E87FF', '#446455FF', '#3B9AB2FF', '#E1AF00FF')
```

```{r}
AML.combined.sct <- readRDS('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/data/AML.combined.sct.rds')
AML.combined.sct
```

### Calculate clusters
performed for a resolution range of 0.1–2 (0.1 step size)
```{r}
res <- seq(0.1, 1.5, by=0.1)

DefaultAssay(AML.combined.sct) <- "integrated"

for (i in res){
  AML.combined.sct <- AML.combined.sct %>%
  FindNeighbors(
    reduction = 'pca', 
    dims = 1:50) %>% 
  FindClusters(resolution = i)
}
```

```{r}
saveRDS(AML.combined.sct, "/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/data/AML.combined.sct.rds")
```

### Check clustering resolution

#### cluster trees and stability
```{r}
clustree(AML.combined.sct, prefix = "integrated_snn_res.", node_text_size = 0) +
  scale_color_manual(values = rev(colors$discrete)) +
  theme(legend.position = "right", 
        legend.text = element_text(size = 15))
ggsave('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/clustree_res.png', width = 20, height = 20)

clustree(AML.combined.sct, prefix = "integrated_snn_res.", node_colour = "sc3_stability", node_text_size = 0) +
  theme(legend.position = "right", 
        legend.text = element_text(size = 15))

ggsave('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/clustree_res_stability.png', width = 20, height = 20)
```

#### silhouette
The silhouette plot displays a measure of how close each point in one cluster is to points in the neighboring clusters and thus provides a way to assess parameters like number of clusters visually. This measure has a range of [-1, 1].
Silhouette coefficients (as these values are referred to as) near +1 indicate that the sample is far away from the neighboring clusters. A value of 0 indicates that the sample is on or very close to the decision boundary between two neighboring clusters and negative values indicate that those samples might have been assigned to the wrong cluster.

```{r}
distance_matrix <- dist(Embeddings(AML.combined.sct[['pca']])[, 1:30])
```

```{r}
res_list <- paste0('integrated_snn_res.', res)
names(res_list) <- paste0('integrated_snn_res.', res)

x <- c()

for (i in res_list){
  clusters <- AML.combined.sct@meta.data[i]
  silhouette <- silhouette(as.numeric(clusters[,1]), dist = distance_matrix)
  AML.combined.sct@meta.data$silhouette_score <- silhouette[,3]
  mean_silhouette_score <- mean(AML.combined.sct@meta.data$silhouette_score)
  x = c(x, mean_silhouette_score)
}

df = data.frame(
    resolution = res_list,
    mean_silhouette_score = x
  )

ggplot(df, aes(resolution, mean_silhouette_score)) +
  geom_col(width = 0.8) +
  ylab('Mean silhouette score') +
    theme_bw() +
    theme(
      axis.title.x = element_blank(),
      axis.text.x = element_text(color = 'black', angle = 45, hjust = 1, vjust = 1),
      panel.grid = element_blank())

  ggsave('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/mean_silhouette_bar.png', height = 4, width = 10)
```

```{r}
res_list <- paste0('integrated_snn_res.', c(0.2, 0.6, 0.7, 0.8, 1.2))
names(res_list) <- paste0('integrated_snn_res.', c(0.2, 0.6, 0.7, 0.8, 1.2))

for (i in res_list){
  clusters <- AML.combined.sct@meta.data[i]
  silhouette <- silhouette(as.numeric(clusters[,1]), dist = distance_matrix)
  AML.combined.sct@meta.data$silhouette_score <- silhouette[,3]
  mean_silhouette_score <- mean(AML.combined.sct@meta.data$silhouette_score)
  x = AML.combined.sct@meta.data %>%
    mutate(barcode = rownames(.)) %>%
    arrange(AML.combined.sct@meta.data[i], -silhouette_score) %>%
    mutate(barcode = factor(barcode, levels = barcode)) 
  p = ggplot(x, aes(barcode, silhouette_score, fill = x[,i])) +
    geom_col() +
    geom_hline(yintercept = mean_silhouette_score, color = 'red', linetype = 'dashed') +
    scale_x_discrete(name = 'Cells') +
    scale_y_continuous(name = 'Silhouette score') +
    scale_fill_manual(name = 'Cluster', values = rep(colors$discrete,2)) +
    ggtitle(i) +
    theme_bw() +
    theme(
      legend.position = 'bottom',
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      panel.grid = element_blank())
  ggsave(paste0('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/silhouette_plot_', i, '.png'), p, height = 5.5, width = 8)
}
```

#### UMAP
```{r}
for (i in res_list){
  x = bind_cols(AML.combined.sct@meta.data, as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)) 
  p = ggplot(x, aes(UMAP_1, UMAP_2, color = x[,i])) +
  geom_point(size = 0.2, alpha = 0.8) +
  theme_bw() +
  scale_color_manual(values = rep(colors$discrete,2)) +
  labs(color = "Cluster") +
  ggtitle(i) +
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  theme(legend.position = "right", panel.grid = element_blank()) +
  annotate(
    geom = "text", x = Inf, y = -Inf,
    label = paste0("n = ", format(nrow(AML.combined.sct@meta.data), big.mark = ",", trim = TRUE)),
    vjust = -1.5, hjust = 1.25, color = "black", size = 2.5)
  
  ggsave(paste0('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/UMAP_Louvain_', i, '.png'), p, height = 6, width = 6.5)
}
```

#### Cluster similarity
```{r}
sce <- as.SingleCellExperiment(AML.combined.sct)
reducedDim(sce, 'PCA_sub') <- reducedDim(sce, 'PCA')[,1:30, drop = FALSE]
g <- scran::buildSNNGraph(sce, use.dimred = 'PCA_sub')
```

ratio = each row/column corresponds to a cluster and each entry contains the ratio of the observed to total weight of edges between cells in the respective clusters. A dataset containing well-separated clusters should contain most of the observed total weight on the diagonal entries, i.e., most edges occur between cells in the same cluster. Indeed, concentration of the weight on the diagonal of indicates that most of the clusters are well-separated, while some modest off-diagonal entries represent closely related clusters with more inter-connecting edges.

```{r}
for (i in res_list){
  ratio <- bluster::pairwiseModularity(g, AML.combined.sct@meta.data[,i], as.ratio = TRUE)
  ratio_to_plot <- log10(ratio+1)
  x = ratio_to_plot %>%
    as_tibble() %>%
    rownames_to_column(var = 'cluster_1') %>%
    pivot_longer(
      cols = 2:ncol(.),
      names_to = 'cluster_2',
      values_to = 'probability') %>%
    mutate(
      cluster_1 = as.character(as.numeric(cluster_1) - 1),
      cluster_1 = factor(cluster_1, levels = rev(unique(cluster_1))),
      cluster_2 = factor(cluster_2, levels = unique(cluster_2))) 
  p = ggplot(x, aes(cluster_2, cluster_1, fill = probability)) +
  geom_tile(color = 'white') +
  geom_text(aes(label = round(probability, digits = 2)), size = 2.5) +
  scale_x_discrete(name = 'Cluster', position = 'top') +
  scale_y_discrete(name = 'Cluster') +
  ggtitle(i) +
  scale_fill_gradient(
    name = 'log10(ratio)', low = 'white', high = '#c0392b', na.value = '#bdc3c7',
    guide = guide_colorbar(
      frame.colour = 'black', ticks.colour = 'black', title.position = 'left',
      title.theme = element_text(hjust = 1, angle = 90),
      barwidth = 0.75, barheight = 10)) +
  coord_fixed() +
  theme_bw() +
  theme(
    legend.position = 'right',
    panel.grid.major = element_blank())
ggsave(paste0('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/cluster_similarity_', i, '.png'), p, height = 6, width = 7)
}
```

#### Cluster stability (bootstrapping)
Derive a matrix of ARI-derived ratios for every pair of original clusters in originals, averaged across bootstrap iterations. High ratios indicate that the clustering in the bootstrap replicates are highly consistent with that of the original dataset. More specifically, high ratios on the diagonal indicate that cells in the same original cluster are still together in the bootstrap replicates, while high ratios off the diagonal indicate that cells in the corresponding cluster pair are still separated.

CAVEATS: bootstrapping only considers the effect of sampling noise and ignores other factors that affect reproducibility in an independent study (e.g., batch effects, donor variation). In addition, it is possible for a poor separation to be highly stable, so highly stable cluster may not necessarily represent some distinct subpopulation.

```{r}
pcs <- reducedDim(sce, 'PCA')[,1:30, drop = FALSE]

myClusterFUN <- function(x) {
    g <- bluster::makeSNNGraph(x, type="jaccard")
    igraph::cluster_louvain(g)$membership
}
```

```{r}
for (i in res_list){
  set.seed(0010010100)
  ratios <- bootstrapStability(pcs, FUN=myClusterFUN, clusters=AML.combined.sct@meta.data[,i])
  pheatmap(ratios, cluster_row=FALSE, cluster_col=FALSE,
    color=viridis::magma(100), breaks=seq(-1, 1, length.out=101),
    main = i, 
    filename = paste0('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/cluster_stability_', i, '.png'), height = 6, width = 7)
}
```

#### Clustering purity
Quantifies the degree to which cells from multiple clusters intermingle in expression space. The “clustering purity” is defined for each cell as the proportion of neighboring cells that are assigned to the same cluster. Well-separated clusters should exhibit little intermingling and thus high purity values for all member cells. High median purity values indicate that most cells in each cluster are primarily surrounded by other cells from the same cluster.
The main difference with silhouette is that purity is ignorant of the intra-cluster variance.

```{r}
for (i in res_list){
  pure <- neighborPurity(reducedDim(sce, "PCA")[,1:30, drop = FALSE], clusters=AML.combined.sct@meta.data[,i])
  pure.data <- as.data.frame(pure)
  pure.data$maximum <- factor(pure.data$maximum)
  pure.data$cluster <- factor(AML.combined.sct@meta.data[,i])
  p = ggplot(pure.data, aes(x=cluster, y=purity, colour=maximum)) +
  scale_color_manual(name = 'Cluster', values = rep(colors$discrete,2)) +
  ggbeeswarm::geom_quasirandom(method="smiley") + 
  theme_bw() +
  ggtitle(i) +
  theme(panel.grid = element_blank())
  ggsave(paste0('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/cluster_purity_', i, '.png'), p, height = 5, width = 6)
}
```

Pick resolution = 0.8, as this appears the best compromise when considering measures of clustering quality and topology of inferred cell lineages.

### Resolution 0.8
```{r}
# choose colors
library(paletteer)
palettes_d_names %>% filter(type != 'sequential')

paletteer_d("dutchmasters::milkmaid")
```

```{r}
colors$clusters <- setNames(
  c('#046C9AFF', '#D69C4EFF', '#899DA4FF', '#C93312FF', '#7B906FFF', 
    '#02401BFF', '#A2A475FF', '#81A88DFF', '#972D15FF', '#CADDE1FF', 
    '#E3C78FFF', '#174D79FF', '#D8B70AFF', '#D4CDB1FF', '#91D1C2FF',
    '#6CA9C3FF', '#00295DFF', '#D9B196FF', '#00A087FF', '#175E78FF'),
  c(0:19))
```

```{r}
UMAP_centers_cluster <- tibble(
  UMAP_1 = as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)$UMAP_1,
  UMAP_2 = as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)$UMAP_2,
  cluster = AML.combined.sct@meta.data$integrated_snn_res.0.8
) %>%
  group_by(cluster) %>%
  summarize(x = median(UMAP_1), y = median(UMAP_2))

bind_cols(AML.combined.sct@meta.data, as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = integrated_snn_res.0.8)) +
  geom_point(size = 0.2, alpha = 0.8) +
  theme_bw() +
  scale_color_manual(values = colors$clusters) +
  labs(color = "Cluster") +
  coord_fixed() +
  geom_text(
    data = UMAP_centers_cluster,
    mapping = aes(x, y, label = cluster),
    nudge_x = 0, nudge_y = 0.5,
    check_overlap = T,
    size = 3, color = 'black',
    fontface = 'bold',
    show.legend = FALSE
  ) +
  annotate(
    geom = "text", x = Inf, y = -Inf,
    label = paste0("n = ", format(nrow(AML.combined.sct@meta.data), big.mark = ",", trim = TRUE)),
    vjust = -1.5, hjust = 1.25, color = "black", size = 2.5
  ) +
  theme(legend.position = "none", panel.grid = element_blank()) 

ggsave('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/UMAP_Louvain_0.8.png', height = 6, width = 5.8)
```

### Number of transcripts and expressed genes by clusters
```{r}
temp_labels <- AML.combined.sct@meta.data %>%
  group_by(integrated_snn_res.0.8) %>%
  tally()

p1 <- ggplot() +
  geom_half_violin(
    data = AML.combined.sct@meta.data, aes(integrated_snn_res.0.8, nCount_SCT, fill = integrated_snn_res.0.8),
    side = "l", show.legend = FALSE, trim = FALSE) +
  geom_half_boxplot(
    data = AML.combined.sct@meta.data, aes(integrated_snn_res.0.8, nCount_SCT, fill = integrated_snn_res.0.8),
    side = "r", outlier.color = NA, width = 0.4, show.legend = FALSE) +
  geom_text(
    data = temp_labels,
    aes(x = integrated_snn_res.0.8, y = -Inf, label = paste0("n = ", format(n, big.mark = ",", trim = TRUE)), vjust = -1),
    color = "black", size = 3) +
  scale_fill_manual(name = 'Cluster', values = colors$clusters) +
  scale_y_continuous(name = "Number of transcripts", labels = scales::comma,
                     expand = c(0.08, 0)) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.text = element_text(color = 'black'))

p2 <- ggplot() +
  geom_half_violin(
    data = AML.combined.sct@meta.data, aes(integrated_snn_res.0.8, nFeature_SCT, fill = integrated_snn_res.0.8),
    side = "l", show.legend = FALSE, trim = FALSE) +
  geom_half_boxplot(
    data = AML.combined.sct@meta.data, aes(integrated_snn_res.0.8, nFeature_SCT, fill = integrated_snn_res.0.8),
    side = "r", outlier.color = NA, width = 0.4, show.legend = FALSE) +
  geom_text(
    data = temp_labels,
    aes(x = integrated_snn_res.0.8, y = -Inf, label = paste0("n = ", format(n, big.mark = ",", trim = TRUE)), vjust = -1),
    color = "black", size = 3) +
  scale_y_continuous(name = "Number of expressed genes", labels = scales::comma,
                     expand = c(0.08, 0)) +
  scale_fill_manual(name = 'Cluster', values = colors$clusters) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.text = element_text(color = 'black'))

ggsave('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/n_transcripts_ex_genes_by_cluster.png', p1 + p2 + 
         plot_layout(ncol = 1, nrow = 2, widths = 10, heights = 3, guides = 'collect'),
       width = 10, height = 6)
```

### Composition by clusters/sample

N cells
```{r}
table_samples_by_clusters <- AML.combined.sct@meta.data %>%
  group_by(sample, integrated_snn_res.0.8) %>%
  summarize(count = n()) %>%
  spread(integrated_snn_res.0.8, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('sample', 'total_cell_count', everything())) %>%
  arrange(factor(sample, levels = levels(AML.combined.sct@meta.data$sample)))

table_clusters_by_samples <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster, sample) %>%
  summarize(count = n()) %>%
  spread(sample, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('cluster', 'total_cell_count', everything())) %>%
  arrange(factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8)))

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(sample) %>%
  tally()

AML.combined.sct@meta.data$sample <- factor(AML.combined.sct@meta.data$sample, 
                                          levels = c("AML4", "AML5", "sAML1"))

p1 <- table_samples_by_clusters %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'sample') %>%
  mutate(sample = factor(sample, levels = levels(AML.combined.sct@meta.data$sample))) %>%
  ggplot(aes(sample, value)) +
  geom_bar(aes(fill = variable), position = 'stack', stat = 'identity') +
  geom_text(
    data = temp_labels,
    aes(x = sample, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 3.5
  ) +
  scale_fill_manual(name = 'Cluster', values = colors$clusters) +
  scale_y_continuous(name = 'Number of cells', labels = scales::comma, expand = c(0.01, 0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'left',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(integrated_snn_res.0.8) %>%
  tally() %>%
  dplyr::rename('cluster' = integrated_snn_res.0.8)

p2 <- table_clusters_by_samples %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'cluster') %>%
  mutate(cluster = factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8))) %>%
  ggplot(aes(cluster, value)) +
  geom_bar(aes(fill = variable), position = 'stack', stat = 'identity') +
  geom_text(
    data = temp_labels,
    aes(x = cluster, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 3.5
  ) +
  scale_fill_manual(name = 'Sample', values = colors$sample) +
  scale_y_continuous(labels = scales::comma, expand = c(0.01, 0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_samples_clusters_by_number.png',
  p1 + p2 +
  plot_layout(ncol = 2, widths = c(
    AML.combined.sct@meta.data$sample %>% unique() %>% length(),
    AML.combined.sct@meta.data$integrated_snn_res.0.8 %>% unique() %>% length()
  )),
  width = 18, height = 8
)
```

Percent
```{r}
table_samples_by_clusters <- AML.combined.sct@meta.data %>%
  group_by(sample, integrated_snn_res.0.8) %>%
  summarize(count = n()) %>%
  spread(integrated_snn_res.0.8, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('sample', 'total_cell_count', everything())) %>%
  arrange(factor(sample, levels = levels(AML.combined.sct@meta.data$sample)))

table_clusters_by_samples <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster, sample) %>%
  summarize(count = n()) %>%
  spread(sample, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('cluster', 'total_cell_count', everything())) %>%
  arrange(factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8)))

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(sample) %>%
  tally()

p1 <- table_samples_by_clusters %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'sample') %>%
  mutate(sample = factor(sample, levels = levels(AML.combined.sct@meta.data$sample))) %>%
  ggplot(aes(sample, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity') +
  geom_text(
    data = temp_labels,
    aes(x = sample, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 3.5
  ) +
  scale_fill_manual(name = 'Cluster', values = colors$clusters) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
     legend.position = 'left',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(integrated_snn_res.0.8) %>%
  tally() %>%
  dplyr::rename('cluster' = integrated_snn_res.0.8)

p2 <- table_clusters_by_samples %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'cluster') %>%
  mutate(cluster = factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8))) %>%
  ggplot(aes(cluster, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity') +
  geom_text(
    data = temp_labels, aes(x = cluster, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 3.5
  ) +
  scale_fill_manual(name = 'Sample', values = colors$sample) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_samples_clusters_by_percent.png',
  p1 + p2 +
  plot_layout(ncol = 2, widths = c(
    AML.combined.sct@meta.data$sample %>% unique() %>% length(),
    AML.combined.sct@meta.data$integrated_snn_res.0.8 %>% unique() %>% length()
  )),
  width = 18, height = 8
)
```

### Sample composition by cell lineage and cell cycle
```{r}
colors$binary <- setNames(
  c('#046C9AFF', 'lightgrey'),
  c('TRUE', 'FALSE')
)
```

```{r}
bind_cols(AML.combined.sct@meta.data,
               as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = integrated_snn_res.0.8 == 5)) +
  geom_point(size = 0.2) +
  theme_bw() +
  scale_color_manual(values = colors$binary) +
  theme(plot.title = element_text(face = "bold"), 
        panel.grid = element_blank()) +
  coord_fixed() 
```

```{r}
AML.combined.sct$refined_lineage <- AML.combined.sct$cell_lineage

identical(AML.combined.sct$refined_lineage, AML.combined.sct$cell_lineage)
AML.combined.sct$refined_lineage <- factor(AML.combined.sct$refined_lineage, 
                                         levels = c("HSC", "LMPP", "GMP", "Prog_RBC", "Prog_Mk", "Prog_DC", "pDC", "cDC2", "CD14 Mono", "CD16 Mono", "CD4 Naive", "CD4 Memory" , "CD8 Naive",  "CD8 Effector_1", "CD8 Effector_2", "CD8 Memory_1", "Treg", "MAIT", "gdT",  "NK", "CD56 bright NK", "CD8 Memory_2", "Prog_B 1", "Prog_B 2", "Naive B", "Memory B", "Plasmablast", 'unclassified'))

AML.combined.sct$refined_lineage[AML.combined.sct$integrated_snn_res.0.8 == 5] <- 'unclassified'
```

```{r}
bind_cols(AML.combined.sct@meta.data,
               as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = refined_lineage == 'unclassified')) +
  geom_point(size = 0.2) +
  theme_bw() +
    scale_color_manual(values = colors$binary) +
  theme(plot.title = element_text(face = "bold"), 
        panel.grid = element_blank()) +
  coord_fixed() 
```

```{r}
colors$cell_type.2 <- setNames(
  colors$cell_type <- c(
  "#FEA47F","#25CCF7","#EAB543","#55E6C1","yellow",
  "#F97F51","#1B9CFC","#F8EFBA","#58B19F","#2C3A47",
  "#B33771","#3B3B98","#FD7272","#9AECDB","#D6A2E8",
  "#6D214F","#182C61","#FC427B","#BDC581","#82589F",
  "#EE5A24","#009432", "#F79F1F", "#A3CB38", "#1289A7",
  "#D980FA", "#B53471", 'lightgrey'), 
c("HSC", "LMPP", "GMP", "Prog_RBC", "Prog_Mk", "Prog_DC", "pDC", "cDC2", "CD14 Mono", "CD16 Mono", "CD4 Naive", "CD4 Memory" , "CD8 Naive",  "CD8 Effector_1", "CD8 Effector_2", "CD8 Memory_1", "Treg", "MAIT", "gdT",  "NK", "CD56 bright NK", "CD8 Memory_2", "Prog_B 1", "Prog_B 2", "Naive B", "Memory B", "Plasmablast", 'unclassified'))
```

```{r}
bind_cols(AML.combined.sct@meta.data, as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = refined_lineage)) +
  geom_point(size = 0.2, alpha = 0.8) +
  theme_bw() +
  scale_color_manual(values = colors$cell_type.2) +
  labs(color = "Cell lineage") +
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  theme(legend.position = "right", panel.grid = element_blank()) +
  coord_fixed() +
  annotate(
    geom = "text", x = Inf, y = -Inf,
    label = paste0("n = ", format(nrow(AML.combined.sct@meta.data), big.mark = ",", trim =
                                    TRUE)),
    vjust = -1.5, hjust = 1.25, color = "black", size = 2.5
  )

ggsave(
  "/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/umap_cell_lineage_refined.png",
  height = 6, width = 9.5
)
```

```{r}
table_samples_by_cc <- AML.combined.sct@meta.data %>%
  group_by(sample, refined_lineage) %>%
  summarize(count = n()) %>%
  spread(refined_lineage, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('sample', 'total_cell_count', everything())) %>%
  arrange(factor(sample, levels = levels(AML.combined.sct@meta.data$sample)))

table_cc_by_samples <- AML.combined.sct@meta.data %>%
  group_by(refined_lineage, sample) %>%
  summarize(count = n()) %>%
  spread(sample, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('refined_lineage', 'total_cell_count', everything())) %>%
  arrange(factor(refined_lineage, levels = levels(AML.combined.sct@meta.data$refined_lineage)))

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(sample) %>%
  tally()

p1 <- table_samples_by_cc %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'sample') %>%
  mutate(sample = factor(sample, levels = levels(AML.combined.sct@meta.data$sample))) %>%
  ggplot(aes(sample, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels,
    aes(x = sample, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 2.8
  ) +
  scale_fill_manual(name = 'Cell lineage', values = colors$cell_type.2) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
     legend.position = 'left',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(refined_lineage) %>%
  tally() 

p2 <- table_cc_by_samples %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'refined_lineage') %>%
  mutate(refined_lineage = factor(refined_lineage, levels = levels(AML.combined.sct@meta.data$refined_lineage))) %>%
  ggplot(aes(refined_lineage, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels, aes(x = refined_lineage, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 2.8
  ) +
  scale_fill_manual(name = 'Sample', values = colors$sample) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_samples_refined_lineage_by_percent.png',
  p1 + p2 +
  plot_layout(ncol = 2, widths = c(
    AML.combined.sct@meta.data$sample %>% unique() %>% length(),
    AML.combined.sct@meta.data$integrated_snn_res.0.8 %>% unique() %>% length()
  )),
  width = 22, height = 8
)
```

```{r}
table_samples_by_cc <- AML.combined.sct@meta.data %>%
  group_by(sample, cell_cycle_seurat) %>%
  summarize(count = n()) %>%
  spread(cell_cycle_seurat, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('sample', 'total_cell_count', everything())) %>%
  arrange(factor(sample, levels = levels(AML.combined.sct@meta.data$sample)))

table_cc_by_samples <- AML.combined.sct@meta.data %>%
  group_by(cell_cycle_seurat, sample) %>%
  summarize(count = n()) %>%
  spread(sample, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('cell_cycle_seurat', 'total_cell_count', everything())) %>%
  arrange(factor(cell_cycle_seurat, levels = levels(AML.combined.sct@meta.data$cell_cycle_seurat)))

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(sample) %>%
  tally()

p1 <- table_samples_by_cc %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'sample') %>%
  mutate(sample = factor(sample, levels = levels(AML.combined.sct@meta.data$sample))) %>%
  ggplot(aes(sample, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels,
    aes(x = sample, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 4
  ) +
  scale_fill_manual(name = 'Cell cycle', values = colors$cell_cycle) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
     legend.position = 'left',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(cell_cycle_seurat) %>%
  tally() 

AML.combined.sct$cell_cycle_seurat <- factor(AML.combined.sct$cell_cycle_seurat, 
                                           levels = c("G1", "S", "G2M"))

p2 <- table_cc_by_samples <- table_cc_by_samples %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'cell_cycle_seurat') %>%
  mutate(cell_cycle_seurat = factor(cell_cycle_seurat, levels = levels(AML.combined.sct@meta.data$cell_cycle_seurat))) %>%
  ggplot(aes(cell_cycle_seurat, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels, aes(x = cell_cycle_seurat, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 4
  ) +
  scale_fill_manual(name = 'Sample', values = colors$sample) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_samples_cell_cycle_by_percent.png',
  p1 + p2 +
  plot_layout(ncol = 2, widths = c(
    AML.combined.sct@meta.data$sample %>% unique() %>% length(),
    AML.combined.sct@meta.data$cell_cycle_seurat %>% unique() %>% length()
  )),
  width = 18, height = 8
)
```

### Cluster composition by cell lineage and cell cycle
```{r}
table_samples_by_cc <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster, refined_lineage) %>%
  summarize(count = n()) %>%
  spread(refined_lineage, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('cluster', 'total_cell_count', everything())) %>%
  arrange(factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8)))

table_cc_by_samples <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(refined_lineage, cluster) %>%
  summarize(count = n()) %>%
  spread(cluster, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('refined_lineage', 'total_cell_count', everything())) %>%
  arrange(factor(refined_lineage, levels = levels(AML.combined.sct@meta.data$refined_lineage)))

temp_labels <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster) %>%
  tally()

p1 <- table_samples_by_cc %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'cluster') %>%
  mutate(cluster = factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8))) %>%
  ggplot(aes(cluster, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels,
    aes(x = cluster, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 2.8
  ) +
  scale_fill_manual(name = 'Cell lineage', values = colors$cell_type.2) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
     legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_cluster_refined_lineage_by_percent.png', p1,
  width = 16, height = 5.5
)

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(refined_lineage) %>%
  tally() 

p2 <- table_cc_by_samples %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'refined_lineage') %>%
  mutate(refined_lineage = factor(refined_lineage, levels = levels(AML.combined.sct@meta.data$refined_lineage))) %>%
  ggplot(aes(refined_lineage, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels, aes(x = refined_lineage, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 2.8
  ) +
  scale_fill_manual(name = 'Cluster', values = colors$clusters) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_refined_lineage_cluster_by_percent.png', p2,
  width = 18, height = 6
)
```

```{r}
table_samples_by_cc <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster, cell_cycle_seurat) %>%
  summarize(count = n()) %>%
  spread(cell_cycle_seurat, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('cluster', 'total_cell_count', everything())) %>%
  arrange(factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8)))

table_cc_by_samples <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cell_cycle_seurat, cluster) %>%
  summarize(count = n()) %>%
  spread(cluster, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('cell_cycle_seurat', 'total_cell_count', everything())) %>%
  arrange(factor(cell_cycle_seurat, levels = levels(AML.combined.sct@meta.data$cell_cycle_seurat)))

temp_labels <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster) %>%
  tally()

p1 <- table_samples_by_cc %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'cluster') %>%
  mutate(cluster = factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8))) %>%
  ggplot(aes(cluster, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels,
    aes(x = cluster, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 4
  ) +
  scale_fill_manual(name = 'Cell cycle', values = colors$cell_cycle) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
     legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_cluster_cell_cycle_by_percent.png', p1,
  width = 16, height = 5
)

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(cell_cycle_seurat) %>%
  tally() 

AML.combined.sct$cell_cycle_seurat <- factor(AML.combined.sct$cell_cycle_seurat, 
                                           levels = c("G1", "S", "G2M"))

p2 <- table_cc_by_samples %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'cell_cycle_seurat') %>%
  mutate(cell_cycle_seurat = factor(cell_cycle_seurat, 
                                    levels = levels(AML.combined.sct@meta.data$cell_cycle_seurat))) %>%
  ggplot(aes(cell_cycle_seurat, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels, aes(x = cell_cycle_seurat, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 4
  ) +
  scale_fill_manual(name = 'Cluster', values = colors$discrete) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_cell_cycle_cluster_by_percent.png', p2,
  width = 6, height = 5
)
```

```{r}
HSC_progenitors <- c("HSC", "LMPP", "GMP", "Prog_B 1", "Prog_B 2")

myeloid <- c("Prog_RBC", "Prog_Mk", "Prog_DC", "pDC", "cDC2", "CD14 Mono", "CD16 Mono")
  
T_NK <- c("CD4 Naive", "CD4 Memory" , "CD8 Naive",  "CD8 Effector_1", "CD8 Effector_2", "CD8 Memory_1", "Treg", "MAIT", "gdT",  "NK", "CD56 bright NK", "CD8 Memory_2")

B <- c("Naive B", "Memory B", "Plasmablast")
```

```{r}
AML.combined.sct$HSC_progenitors <- ifelse(AML.combined.sct$refined_lineage %in% HSC_progenitors, '1', '0')
AML.combined.sct$myeloid <- ifelse(AML.combined.sct$refined_lineage %in% myeloid, '1', '0')
AML.combined.sct$T_NK <- ifelse(AML.combined.sct$refined_lineage %in% T_NK, '1', '0')
AML.combined.sct$B <- ifelse(AML.combined.sct$refined_lineage %in% B, '1', '0')

AML.combined.sct$aggregated_lineage <- ifelse(AML.combined.sct$refined_lineage %in% HSC_progenitors, 'HSC_progenitors', ifelse(
  AML.combined.sct$refined_lineage %in% myeloid, 'myeloid', ifelse(
    AML.combined.sct$refined_lineage %in% T_NK, 'T_NK', ifelse(
      AML.combined.sct$refined_lineage %in% B, 'B', 'unclassified'
    )
  )
))
AML.combined.sct$aggregated_lineage <- factor(AML.combined.sct$aggregated_lineage,
                                            levels = c('HSC_progenitors', 'myeloid', 'T_NK', 'B', 'unclassified'))

saveRDS(AML.combined.sct, "/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/data/AML.combined.sct.rds")
```

```{r}
colors$aggregated_lineage <- setNames(
  c('#D69C4EFF','#C93312FF', '#174D79FF', '#CADDE1FF', 'lightgrey'),
  c('HSC_progenitors', 'myeloid', 'T_NK', 'B', 'unclassified')
)
```

```{r}
bind_cols(AML.combined.sct@meta.data,
          as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = aggregated_lineage)) +
  geom_point(size = 0.5, alpha = 0.8) +
  theme_bw() +
  scale_color_manual(name = 'Cell lineage', values = colors$aggregated_lineage) +
  theme(legend.position = "right", 
        panel.grid = element_blank()) 

ggsave('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/celltype_populations_aggregated.png',
        height = 4.5, width = 6)

bind_cols(AML.combined.sct@meta.data,
          as.data.frame(AML.combined.sct@reductions$UMAP@cell.embeddings)) %>%
  ggplot(aes(UMAP_1, UMAP_2, color = aggregated_lineage)) +
  geom_point(size = 0.5, alpha = 0.8) +
  theme_bw() +
  scale_color_manual(name = 'Cell lineage', values = colors$aggregated_lineage) +
  theme(legend.position = "right", 
        panel.grid = element_blank()) +
  facet_wrap(~sample)

ggsave('/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/celltype_populations_aggregated_split.png', height = 4.5, width = 15)
```

```{r}
table_samples_by_aggr <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster, aggregated_lineage) %>%
  summarize(count = n()) %>%
  spread(aggregated_lineage, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('cluster', 'total_cell_count', everything())) %>%
  arrange(factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8)))

table_aggr_by_samples <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(aggregated_lineage, cluster) %>%
  summarize(count = n()) %>%
  spread(cluster, count, fill = 0) %>%
  ungroup() %>%
  mutate(total_cell_count = rowSums(.[c(2:ncol(.))])) %>%
  dplyr::select(c('aggregated_lineage', 'total_cell_count', everything())) %>%
  arrange(factor(aggregated_lineage, levels = levels(AML.combined.sct@meta.data$aggregated_lineage)))

temp_labels <- AML.combined.sct@meta.data %>%
  dplyr::rename('cluster' = 'integrated_snn_res.0.8') %>%
  group_by(cluster) %>%
  tally()

p1 <- table_samples_by_aggr %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'cluster') %>%
  mutate(cluster = factor(cluster, levels = levels(AML.combined.sct@meta.data$integrated_snn_res.0.8))) %>%
  ggplot(aes(cluster, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels,
    aes(x = cluster, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 4
  ) +
  scale_fill_manual(name = 'Aggregated cell lineage', values = colors$aggregated_lineage) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
     legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 0, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_cluster_aggr_lineage_percent.png', p1,
  width = 16, height = 5
)

temp_labels <- AML.combined.sct@meta.data %>%
  group_by(aggregated_lineage) %>%
  tally() 

p2 <- table_aggr_by_samples %>%
  dplyr::select(-c('total_cell_count')) %>%
  reshape2::melt(id.vars = 'aggregated_lineage') %>%
  mutate(aggregated_lineage = factor(aggregated_lineage, 
                                    levels = levels(AML.combined.sct@meta.data$aggregated_lineage))) %>%
  ggplot(aes(aggregated_lineage, value)) +
  geom_bar(aes(fill = variable), position = 'fill', stat = 'identity', width = 0.8) +
  geom_text(
    data = temp_labels, aes(x = aggregated_lineage, y = Inf, label = paste0('n = ', format(n, big.mark = ',', trim = TRUE)), vjust = -1),
    color = 'black', size = 4
  ) +
  scale_fill_manual(name = 'Cluster', values = colors$clusters) +
  scale_y_continuous(name = 'Percentage [%]', labels = scales::percent_format(), expand = c(0.01,0)) +
  coord_cartesian(clip = 'off') +
  theme_bw() +
  theme(
    legend.position = 'right',
    text = element_text(size = 13, color = 'black'),
    axis.text = element_text(color = 'black'),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 20, r = 0, b = 0, l = 10, unit = 'pt')
  )

ggsave(
  '/hpcnfs/scratch/PGP/SCMseq/short_read_analysis/plots/integration/Louvain_resolution/composition_aggr_lineage_cluster_percent.png', p2,
  width = 6, height = 5
)
```

```{r}
sessionInfo()
```

