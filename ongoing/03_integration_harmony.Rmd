---
title: "integration_harmony"
output: html_document
---
## Set up
```{r, setup, include=FALSE}
# set working directory
knitr::opts_knit$set(root.dir = '/Users/ieo4874/Desktop/working/SCMseq/')
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, echo=F, message=F, warning=F}
#load packages
library(tidyverse)
library(Seurat)
library(scran)
library(scater)
library(patchwork)
library(viridis)
library(ggforce)
library(gghalves)
library(ggridges)
library(scDblFinder)
library(SeuratObject)
```

```{r}
# set paths
path_main <- '/Users/ieo4874/Desktop/working/SCMseq/'
path_data <- paste0(path_main, 'data/')
path_results <- paste0(path_main, 'results_and_plots/integration_harmony/')
```

```{r}
# samples
samples <- c('AML4', 'AML5', 'sAML1', 'AML2', 'AML3', 'sAML4')
all <- c(samples, 'healthy BM')
```

```{r, warning=FALSE, message=FALSE}
#set colors 
colors <- list()

colors$sample <- setNames(
  c("#227093", "#ffb142", "#485460", '#F9791EFF', '#C0D8D8FF', '#009E73FF', '#F0F0F0'), 
  all
)

colors$SRSF2_state <- setNames(
  c("#FF9932FF", "#405D61FF", '#F0F0F0'),
  c("SRSF2 mutated", "SRSF2 unmutated", 'healthy BM')
)

colors$cell_cycle <- setNames(
  c("#45aaf2", "#f1c40f", "#e74c3c"),
  c("G1", "S", "G2M")
)

colors$discrete <- c(
  '#046C9AFF', '#D69C4EFF', '#899DA4FF', '#C93312FF', '#D8B70AFF',
  '#02401BFF', '#A2A475FF', '#81A88DFF', '#972D15FF', '#CADDE1FF',
  '#7B906FFF', '#174D79FF',  '#898989FF', '#D4CDB1FF', '#708090FF',
  '#6CA9C3FF', '#3A3533FF', '#000E33FF', '#800000FF',  '#175E78FF')
```

## Transfer lineage metadata from scmap assignment
```{r}
merged_seurat <- readRDS(paste0(path_data, 'merged_seurat_counts.rds'))
merged_mapped_log <- readRDS(paste0(path_data, 'merged_mapped_log.rds'))
identical(colnames(merged_seurat), colnames(merged_mapped_log)) #TRUE
```

```{r}
merged_seurat$lineage <- merged_mapped_log$lineage
merged_seurat$lineage <- factor(merged_seurat$lineage, levels = unique(merged_seurat$lineage))
merged_seurat$score <- merged_mapped_log$score
merged_seurat$pt.Myelocytes <- merged_mapped_log$pt.Myelocytes
merged_seurat$pt.cDC <- merged_mapped_log$pt.cDC
merged_seurat$pt.Megakaryocte <- merged_mapped_log$pt.Megakaryocte
merged_seurat$pt.Erythroid <- merged_mapped_log$pt.Erythroid
merged_seurat$pt.B.cells <- merged_mapped_log$pt.B.cells
```

## SCT normalization 
This single command replaces NormalizeData(), ScaleData(), and FindVariableFeatures().
Transformed data will be available in the SCT assay, which is set as the default after running sctransform:
*'counts' = corrected counts
*'data' = log1p(counts)
*'scale.data' = pearson residuals
```{r, warning=FALSE, message=FALSE}
merged_seurat <- SCTransform(merged_seurat, 
                    assay = 'RNA',
                    new.assay.name = 'SCT',
                    residual.features = NULL, #all genes
                    variable.features.n = 3000,
                    vars.to.regress = "percent_MT", 
                    conserve.memory = TRUE,
                    #return.only.var.genes = FALSE,
                    do.correct.umi = TRUE,
                    verbose = T)
```

## Cell cycle analysis
```{r}
cc.genes.updated.2019
```

```{r, warning=FALSE, message=FALSE}
merged_seurat <- CellCycleScoring(
  merged_seurat,
  s.features = cc.genes$s.genes,
  g2m.features = cc.genes$g2m.genes,
  assay = 'SCT'
)
merged_seurat@meta.data$cell_cycle_seurat <- merged_seurat@meta.data$Phase
merged_seurat@meta.data$Phase <- NULL
merged_seurat@meta.data$cell_cycle_seurat <- factor(
  merged_seurat@meta.data$cell_cycle_seurat, levels = c("G1", "S", "G2M")
)
```

## Set cohort metadata
```{r}
merged_seurat$SRSF2_status <- ifelse(
  merged_seurat$sample %in% c('AML4', 'AML5', 'sAML1'), 'SRSF2 mutated', ifelse(
    merged_seurat$sample %in% c('AML2', 'AML3', 'sAML4'), 'SRSF2 unmutated', 'healthy BM'
  )
)

merged_seurat$SRSF2_status <- factor(merged_seurat$SRSF2_status, levels = c("SRSF2 mutated", "SRSF2 unmutated", 'healthy BM'))
```

## Principal component analysis
```{r, warning=FALSE, message=FALSE}
# Perform linear dimensional reduction on 50 PCs (default)
merged_seurat <- RunPCA(merged_seurat, npcs = 50)
```

```{r}
DimPlot(merged_seurat, reduction = 'pca', group.by = 'sample', cols = colors$sample, pt.size = 0.1, shuffle = T) +
  theme_bw() +
  ggtitle('Before integration') +
  theme(panel.grid = element_blank())

ggsave(paste0(path_results, 'plots/pc_sample_before_integration.png'), height = 4, width = 5.5)
```

```{r}
VlnPlot(object = merged_seurat, features = "PC_1", group.by = "sample", cols = colors$sample, pt.size = 0)
```

```{r, include=TRUE, warning=FALSE, message=FALSE, out.width="50%"}
# determine the ‘dimensionality’ of the dataset and choose PCs to include

ElbowPlot(merged_seurat, ndims = 50, reduction = 'pca') +
  #geom_vline(xintercept = 30, color = "red") +
  theme_bw() +
  theme(panel.grid = element_blank())

ggsave(paste0(path_results, "plots/elbow_plot.png"), width=6, height=6)
```

## Integration
```{r}
library(harmony)
```

```{r}
merged_seurat <- merged_seurat %>% RunHarmony("sample", plot_convergence = TRUE)
```

```{r}
DimPlot(merged_seurat, reduction = 'harmony', group.by = 'sample', cols = colors$sample, pt.size = 0.1, shuffle = T) +
  theme_bw() +
  ggtitle('After integration') +
  theme(panel.grid = element_blank())

ggsave(paste0(path_results, 'plots/pc_sample_after_integration.png'), height = 4, width = 5.5)
```

```{r}
VlnPlot(object = merged_seurat, features = "harmony_1", group.by = "sample", cols = colors$sample, pt.size = 0)
```

## Run UMAP
```{r, include=TRUE, warning=TRUE, message=TRUE}
merged_seurat <- RunUMAP(
  merged_seurat,
  reduction.name = "UMAP",
  reduction = "harmony",
  dims = 1:50,
  n.components = 2,
  seed.use = 100
)
```

```{r}
saveRDS(merged_seurat, paste0(path_data, 'merged_seurat_integrated.rds')) 
```

## Plots
```{r}
DimPlot(merged_seurat, reduction = 'UMAP', group.by = 'sample', cols = colors$sample, pt.size = 0.1, shuffle = T) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.title = element_blank())

ggsave(paste0(path_results, 'plots/umap_sample.png'), 
       width = 6.5, height = 5)
```

```{r}
DimPlot(merged_seurat, reduction = 'UMAP', group.by = 'SRSF2_status', cols = colors$SRSF2_state, pt.size = 0.1, shuffle = T) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.title = element_blank())

ggsave(paste0(path_results, 'plots/umap_SRSF2_status.png'), 
       width = 6.5, height = 5)
```

```{r}
DimPlot(merged_seurat, reduction = 'UMAP', group.by = 'cell_cycle_seurat', cols = colors$cell_cycle, pt.size = 0.1, shuffle = T) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.title = element_blank())

ggsave(paste0(path_results, 'plots/umap_cell_cycle.png'), 
       width = 6.5, height = 5)
```

```{r}
sessionInfo()
```
